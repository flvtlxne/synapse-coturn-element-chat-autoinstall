worker_processes auto;

events {
    worker_connections 1024;
    multi_accept on;
}

http {
    server_tokens off;

    map $time_local $time_local_no_tz {
        "~^(?<time>.+) \+0000$" "$time";
    }

    log_format main '$remote_addr [$time_local_no_tz] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log crit;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    open_file_cache max=1000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    limit_req_zone $binary_remote_addr zone=weblimit:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=adminlimit:10m rate=50r/s;

    server {
        listen 80;
        listen [::]:80;
        server_name {{ FULL_DOMAIN }};
        return 301 https://{{ FULL_DOMAIN }}$request_uri;
    }

    server {

        listen 443 ssl;
        listen [::]:443;
        server_name {{ FULL_DOMAIN }};

        gzip on;
		gzip_comp_level 5;
		gzip_min_length 256;
		gzip_proxied any;
		gzip_types
			application/atom+xml
			application/javascript
			application/x-javascript
			application/json
			application/rss+xml
			application/vnd.ms-fontobject
			application/x-font-ttf
			application/xhtml+xml
			application/xml
			font/opentype
			image/svg+xml
			image/x-icon
			text/css
			text/html
			text/plain
			text/xml
			text/javascript;
		gzip_vary on;

        ssl_certificate /etc/nginx/fullchain.pem;
        ssl_certificate_key /etc/nginx/privkey.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_stapling on;
        ssl_stapling_verify on;
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;

        client_max_body_size 20M;

        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; font-src 'self'; script-src 'self'; frame-src 'self'; connect-src 'self';";

        location / {

            limit_req zone=weblimit burst=50;

            proxy_pass http://element:80;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            add_header Content-Security-Policy "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; font-src 'self'; script-src 'self' 'unsafe-eval'; frame-src 'self'; connect-src 'self';";
        }

        location ~ ^/_matrix/ {

            proxy_pass http://synapse:8008;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location ~ ^/_synapse/client/ {

            proxy_pass http://synapse:8008;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /{{ PGADMIN_PREFIX }} {

            proxy_pass http://pgadmin:80/{{ PGADMIN_PREFIX }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
        }

        location /{{ GRAFANA_PATH_PREFIX }} {

            proxy_pass http://grafana:3000/{{ GRAFANA_PATH_PREFIX }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
        }
    }
}