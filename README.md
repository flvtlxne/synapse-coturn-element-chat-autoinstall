## Дисклеймер

Данный репозиторий является форком https://github.com/AntineutronVS/synapse-coturn-element-chat. Внесено множество изменений в структуру проекта, добавлена функциональность автоматической установки, снятия резервных копий и восстановления из бэкапов.

## Подготовка машины

Тестировалось на VPS с Debian 12 и Ubuntu 24.04. В скрипте стоит проверка ОС, на любых других дистрибутивах, кроме Ubuntu и Debian, установщик работать не будет! Крайне рекомендуется иметь как минимум 2 гигабайта RAM. Текстовые сообщения, аудио- и видеозвонки работают корректно, проверялось как на веб-версии, так и на мобильных устройствах (Android, IOS). Для корректной работы крайне рекомендуется использовать арендованный VPS, находящийся за пределами РФ.

## Установка

Если после клонирования репозитория скрипты не являются исполняемыми, то необходимо выполнить команду chmod +x.

Запуск установки выполняется через ./install.sh, данный скрипт обновит системные пакеты, добавит swap, установит Docker (если уже установлен на системе - можно данный шаг пропустить), установит TLS-сертификат от Let's Encrypt, создаст необходимые для конфигурационных файлов директории. После чего начнётся этап интерактивной установки, где Вы сможете задать креды для Postgres, PGAdmin, Grafana, Prometheus, сгенерировать секрет для TURN. В квадратных скобках написаны дефолтные значения, если нажать Enter, то применится дефолтное значение для переменной в файле .env. После этого будет предложено установить systemd-юниты для автоматического обновления TLS-сертификата (скрипт systemd.sh).

ВАЖНО: если вдруг после завершения скрипта пользователь не будет добавлен в группу docker, то необходимо выйти из SSH-сессии и переподключиться к серверу, после чего проверить наличие пользователя в группе.

## Файлы конфигурации

Все необходимые конфиги создатутся автоматически, файл .env будет заполнен в соответствии с Вашими данными, которые Вы указали в процессе установки. Заполнить нужно будет только переменную PUBLIC_IP_ADDR= в .env (внешний IP-адрес сервера), а также переменные relay-ip= и external-ip= в файле turn/turnserver.conf.

## Запуск

```bash
docker compose build nginx
docker compose up -d
```

## Создание учётных записей

Учётные записи пользователей создаются следующей командой:

```
docker exec -it sas_messenger_matrix_synapse register_new_matrix_user -c /data/homeserver.yaml
```
Первая учётная запись должна иметь админские права, остальные - по желанию.

В дальнейшем все учётные записи для пользователей будут также создаваться через эту команду.

## Резервное копирование

Скрипты резервного копирования лежат в директории /backup. Там же находится файл конфигурации env.tpl, который Вы можете редактировать в зависимости от Ваших нужд (к примеру, указать другую директорию хранения бэкапов или срок их хранения на сервере). Скрипт install.sh создаст директории, где будут храниться бэкапы, после чего произведёт установку systemd-юнита, который будет снимать бэкапы раз в сутки (стандартное время - 03:00). Скрипт backup.sh произведёт процедуру снятия резервной копии контейнеров Postgres, Synapse и Element, после чего поместит архивы в соответствующие контейнерам директории, также он проверяет наличие резервных копий, и если они не соответствуют параметру, указанному в переменной RETENTION_DAYS=, то удаляет их. Скрипт restore.sh отвечает за процесс восстановления из резервной копии и выведет все доступные бэкапы на экран, после чего необходимо будет ввести таймштамп бэкапа, из которого Вы хотите восстановиться. Если же просто нажать Enter, то будет выбран бэкап, снятый последним.

## Планы на будущее
Написать плейбук для Ansible.